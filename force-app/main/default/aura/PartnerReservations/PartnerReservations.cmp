<!--
 - Created by dave on 2020-09-30.
 -->

<aura:component description="PartnerReservations"
                controller="Partner_OutstandingBoatOrders"
                implements="forceCommunity:availableForAllPageTypes">
  <aura:attribute name="isFactoryStore" type="Boolean" default="false" />
  <aura:attribute name="availableLists" type="String[]" />
  <aura:attribute name="selectedList" type="String" />
  <aura:attribute name="allRecords" type="List" />
  <aura:attribute name="filteredRecords" type="List" />
  <aura:attribute name="isReserving" type="Boolean" default="false" />

  <ltng:require scripts="{!join(',', $Resource.Libraries +'/js/LightningApex.js',
                                     $Resource.Libraries +'/js/LightningUtils.js') }"
                afterScriptsLoaded="{!c.afterScripts}" />


  <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
  <aura:handler event="c:lgnd_ListSelector_Event"
                action="{!c.handleListChange}" />

  <c:Lgnd_Spinner_dh aura:id="spinner" />

  <div class="slds-page-header">
    <div class="slds-page-header__row">
      <div class="slds-page-header__col-title">
        <div class="slds-media">
          <div class="slds-media__figure">
            <lightning:icon iconName="standard:data_streams" />
          </div>
          <div class="slds-media__body">
            <div class="slds-picklist slds-dropdown-trigger slds-dropdown-trigger--click">
              <p class="slds-text-title--caps slds-line-height--reset">
                {! if( v.isReserving, 'Create Reservation','Reservations' )}
              </p>
              <aura:if isTrue="{! not( v.isReserving)}">
                <c:lgnd_ListSelector value="{!v.selectedList}"
                                     listOptions="{!v.availableLists}"
                                     aura:id="listSelector--Cmp" />
              </aura:if>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="slds-page-header__row">

    </div>
  </div>
  <div>
    <aura:if isTrue="{! not( v.isReserving)}">
      <ul class="slds-accordion" aura:id="theAccordion">

      <aura:iteration items="{!v.filteredRecords}" var="record" indexVar="idx">
        <li class="slds-accordion__list-item" data-name="{!record.name}">
          <section class="slds-accordion__section">
            <div class="slds-accordion__summary">
              <h2 class="slds-accordion__summary-heading">
                <button class="slds-button slds-button_reset slds-accordion__summary-action"
                        onclick="{!c.toggleAccordion}"
                        data-value="{!record.name}">
                  <lightning:icon iconName="utility:switch"
                                  class="slds-accordion__summary-action-icon
                                         slds-button__icon
                                         slds-button__icon_left"
                                  size="xx-small"/>
                  {!record.name}
                </button>
                <lightning:badge label="{!record.count}"
                                 class="slds-float_right" />
              </h2>
            </div>
            <div class="slds-accordion__content">
              <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-max-medium-table--stacked " aura:id="listTable">
                <thead>
                  <tr class="slds-text-title_caps slds-line-height_reset">
                    <th scope="col">Order Date</th>
                    <th scope="col">Order #</th>
                    <th scope="col">Invoice #</th>
                    <th scope="col">Invoice Stage</th>
                    <th scope="col">Order Specific Items</th>
                    <th scope="col" class="slds-text-align_right slds-p-right_xx-small">Reserved For</th>
                  </tr>
                </thead>
                <tbody>
                  <aura:iteration items="{!record.records}" var="item">
                    <tr>
                      <td data-label="Order Date">
                        <lightning:formattedDateTime value="{!item.orderDate}" />
                      </td>
                      <td data-label="Order #">{!item.dealerOrderName}</td>
                      <td data-label="Invoice #">{!item.erpOrderNumber}</td>
                      <td data-label="Invoice Stage">{!item.erpOrderStage}</td>
                      <td data-label="Order Specific Items">
                        <ul class='build-items'>
                          <aura:iteration items="{!item.lineItems}" var="buildItem">
                            <li>{!buildItem}</li>
                          </aura:iteration>
                        </ul>
                      </td>
                      <td data-label="Reserved For" class="slds-text-align_right slds-p-right_xx-small">
                        <aura:if isTrue="{! and( not(v.isFactoryStore), !empty(item.reservedForCustomerId))}">
                          {!item.reservedForCustomerName}
                        </aura:if>
                        <aura:if isTrue="{! and( v.isFactoryStore, !empty(item.retailErpId))}">
                          {!item.retailErpName}
                        </aura:if>
                        <aura:if isTrue="{! and( empty(item.reservedForCustomerId), empty(item.retailErpId))}">
                          <lightning:button label="Reserve Now"
                                            value="{!item}"
                                            onclick="{!c.handleReservation}"/>
                        </aura:if>
                      </td>
                    </tr>
                  </aura:iteration>
                </tbody>
              </table>
            </div>
          </section>
        </li>
      </aura:iteration>

    </ul>
    </aura:if>

    <aura:if isTrue="{! v.isReserving}">
      Reservation form
    </aura:if>

  </div>
</aura:component>
